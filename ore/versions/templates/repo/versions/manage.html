{% extends "repo/projects/_manage_page.html" %}
{% load crispy_forms_tags %}
{% load permissions %}
{% load static %}
{% block title %}
Manage | {{ version.name }} | {{ proj.name }}
{% endblock %}
{% block manage_page %}

<a href="{{ version.get_absolute_url }}"><h1 style="margin-top: 0;">{{ version.name }}</h1></a>
<br>

{% ifpermitted user "version.edit" proj %}
<div class="panel panel-default">
    <div class="panel-heading">
        <h3 class="panel-title">Options</h3>
    </div>
    <ul class="list-group">
        <li class="list-group-item">
            <h4 class="list-group-item-heading spacey-heading">Edit Version</h4>
            {% crispy edit %}
        </li>

        <li class="list-group-item">
            <h4 class="list-group-item-heading">Upload Additional File</h4>
            {% crispy file_upload %}
        </li>
    </ul>
</div>
{% endifpermitted %}

{% ifpermitted user "version.edit" proj %}
{% if version.files.count %}
<div class="panel panel-default">
    <div class="panel-heading">
        <h3 class="panel-title">File Management</h3>
    </div>
    <ul class="list-group">
        {% for file in version.files.all %}
        <li class="list-group-item">
            <h4 class="list-group-item-heading">{{ file.file_name }}</h4>

            <form method="POST" action="">
                {% csrf_token %}
                <input type="hidden" name="file_id" value="{{ file.id }}">

                <div class="btn-group">
                    <button type="submit" class="btn btn-success" name="action" value="promote_file" {% if version.primary_file == file %}disabled="disabled"{% endif %}>
                        <i class="fa fa-arrow-up"></i>
                        {% if version.primary_file == file %}Already Primary{% else %}Make Primary{% endif %}
                    </button>
                    <button type="submit" class="btn btn-danger" name="action" value="delete_file">
                        <i class="fa fa-times"></i>
                        Delete
                    </button>
                </div>
            </form>
        </li>
        {% endfor %}
    </ul>
</div>
{% endif %}
{% endifpermitted %}

<div class="panel panel-default">
    <div class="panel-heading">
        <h3 class="panel-title">Destructive Actions</h3>
    </div>
    <ul class="list-group">
        <li class="list-group-item">
            <div class="btn-group">
                {% ifpermitted user "version.edit" proj %}
                    <button type="button" class="btn btn-warning" data-toggle="modal" data-target="#rename-modal">
                        Rename
                    </button>
                {% endifpermitted %}

                {% ifpermitted user "version.delete" proj %}
                    <button type="button" class="btn btn-danger" data-toggle="modal" data-target="#delete-modal">
                        <i class="fa fa-times"></i>
                        Delete
                    </button>
                {% endifpermitted %}
            </div>
        </li>
    </ul>
</div>

<div class="modal fade" id="rename-modal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span><i class="fa fa-times"></i></span></button>
                <h4 class="modal-title">Rename version</h4>
            </div>
            {% crispy rename %}
        </div>
    </div>
</div>

<div class="modal fade" id="delete-modal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span><i class="fa fa-times"></i></span></button>
                <h4 class="modal-title">Delete version</h4>
            </div>
            <div class="modal-body">
                <p>Deleting removes all data, including files, related to this version forever and is <em>not reversible</em>.</p>
                <p>Please type the name of the version to confirm deletion.</p>

                <form action="{% url 'repo-versions-delete' namespace=proj.namespace.name project=proj.name version=version.name %}"
                      method="POST"
                      class="js-lock-form"
                      data-confirm="{{ version.name }}"
                      data-input="input[name='lock']"
                      data-locks="button">

                    {% csrf_token %}
                    <div class="input-group">
                        <input type="text" name="lock" class="form-control">
                        <span class="input-group-btn">
                            <button type="submit" class="btn btn-danger">Delete</button>
                        </span>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
    {{ block.super }}
    <script type="text/javascript">
        {% if show_modal %}
            $(function () {
                var $modal = $("#{{ show_modal }}");
                $modal.removeClass('fade');
                $modal.modal('show');
                $modal.addClass('fade');
            });
        {% endif %}
    </script>
{% endblock %}
